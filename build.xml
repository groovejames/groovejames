<project name="grooveJames" basedir="." default="all">

	<property name="launch4j.dir" location="etc/launch4j"/>

	<fileset id="libs" dir="lib" includes="*.jar"/>

	<path id="compile.classpath">
		<fileset refid="libs"/>
	</path>


	<target name="compile" description="compile all">
		<mkdir dir="out/production/gs"/>
		<javac
			srcdir="src"
			destdir="out/production/gs"
			classpathref="compile.classpath"
			debug="true"
			deprecation="true"
			source="1.6"
			target="1.6"
            includeantruntime="false"
            includejavaruntime="false"
		/>
		<copy todir="out/production/gs">
			<fileset dir="src">
				<include name="**/*.png"/>
				<include name="**/*.gif"/>
                <include name="**/*.properties"/>
                <include name="**/*.bxml"/>
                <include name="**/*.json"/>
			</fileset>
		</copy>
	</target>


	<target name="jar" depends="readBuildNumber, compile">
		<jar destfile="out/grooveJames-${build.number}.jar" compress="true">
            <manifest>
                <attribute name="Main-Class" value="groovejames.gui.Main"/>
                <attribute name="Build-Number" value="${build.number}"/>
                <!--<attribute name="SplashScreen-Image" value="org/lastjames/gui/resources/splash.png"/>-->
            </manifest>
            <zipgroupfileset refid="libs"/>
			<fileset dir="out/production/gs"/>
		</jar>
	</target>


	<target name="exe" depends="readBuildNumber, jar">
		<taskdef
			name="launch4j"
			classname="net.sf.launch4j.ant.Launch4jTask"
			classpath="${launch4j.dir}/launch4j.jar"
		/>
        <!--
		<launch4j
			configFile="launch4j.xml"
			jarPath="out/grooveJames-${build.number}.jar"
			outfile="out/grooveJames-${build.number}.exe"
			fileVersion="0.0.0.${build.number}"
			txtFileVersion="${build.number}"
			productVersion="0.0.0.${build.number}"
			txtProductVersion="${build.number}"
		/>
        -->
        <launch4j>
            <config dontWrapJar="false"
                    headerType="gui"
                    jarPath="out/grooveJames-${build.number}.jar"
                    outfile="out/grooveJames-${build.number}.exe"
                    errtitle="GrooveJames - Error"
                    priority="normal"
                    downloadurl="http://java.com/download"
                    customprocname="false"
                    stayalive="false"
                    icon="butler.ico">
                <jre minversion="1.6.0" jdkpreference="preferJre">
                    <!--<opt>-Dsun.java2d.d3d=false</opt>-->
                </jre>
                <singleinstance
                    mutexName="grooveJames"
                    windowTitle="GrooveJames"
                />
                <versioninfo
                    fileVersion="0.0.0.${build.number}"
                    txtFileVersion="0.${build.number}"
                    fileDescription="GrooveJames - ripping tracks from Grooveshark.com"
                    copyright="The GrooveJames developers"
                    productVersion="0.0.0.${build.number}"
                    txtProductVersion="0.${build.number}"
                    productName="GrooveJames"
                    companyName=""
                    internalName="GrooveJames"
                    originalFilename="grooveJames.exe"
                />
                <messages
                    startupErr="An error occurred while starting the application."
                    bundledJreErr="This application was configured to use a bundled Java Runtime Environment but the runtime is missing or corrupted."
                    jreVersionErr="Cannot find a suitable Java Runtime Environment.\nGrooveJames requires Java 6 or higher.\n\nYour browser will now point you to a website\nwhere you can download the latest Java version.\n\nNote: GrooveJames requires at least Java version"
                    launcherErr="The registry refers to a nonexistent Java Runtime Environment installation or the runtime is corrupted."
                    instanceAlreadyExistsMsg="GrooveJames is already running."
                />
            </config>
        </launch4j>
    </target>


	<target name="src" depends="readBuildNumber" description="create source distribution zip file">
		<mkdir dir="out"/>
		<zip destfile="out/grooveJames-${build.number}-src.zip">
			<zipfileset dir="." prefix="grooveJames">
				<exclude name="out/**"/>
				<exclude name="**/*.log"/>
                <exclude name="**/*.log.*"/>
                <exclude name="**/Thumbs.db"/>
			</zipfileset>
		</zip>
	</target>


    <target name="readBuildNumber">
        <property file="src/groovejames/gui/version.properties"/>
        <echo message="build-number: ${build.number}" level="info"/>
    </target>


    <target name="incBuildNumber">
        <propertyfile file="src/groovejames/gui/version.properties">
            <entry key="build.number" type="int" operation="+" default="0"/>
        </propertyfile>
        <property file="src/groovejames/gui/version.properties"/>
        <echo message="build-number: ${build.number}" level="info"/>
    </target>


	<target name="all" depends="clean, incBuildNumber, exe, src" description="cleanup and rebuild executable and source distribution zip file"/>


	<target name="clean" description="cleanup">
		<delete dir="out"/>
		<delete dir="." includes="*.log,*.log.*"/>
	</target>

</project>
