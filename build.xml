<project name="grooveJames" basedir="." default="all">

	<property name="launch4j.dir" location="C:/dev/projects/launch4j-3.0.1"/>

    <available property="launch4j.isAvailable" file="${launch4j.dir}/launch4j.jar"/>

	<fileset id="libs" dir="lib" includes="*.jar"/>

	<path id="compile.classpath">
		<fileset refid="libs"/>
	</path>


	<target name="compile" description="compile all">
		<mkdir dir="out/production/gs"/>
		<javac
			srcdir="src"
			destdir="out/production/gs"
			classpathref="compile.classpath"
			debug="true"
			deprecation="true"
			source="1.6"
			target="1.6"
            includeantruntime="false"
            includejavaruntime="false"
		/>
		<copy todir="out/production/gs">
			<fileset dir="src">
				<include name="**/*.png"/>
				<include name="**/*.gif"/>
                <include name="**/*.properties"/>
                <include name="**/*.bxml"/>
                <include name="**/*.json"/>
			</fileset>
		</copy>
	</target>


	<target name="jar" depends="readBuildNumber, compile">
		<jar destfile="out/grooveJames.jar" compress="true">
            <manifest>
                <attribute name="Main-Class" value="groovejames.gui.Main"/>
                <attribute name="Build-Number" value="${build.number}"/>
                <!--<attribute name="SplashScreen-Image" value="org/lastjames/gui/resources/splash.png"/>-->
            </manifest>
            <zipgroupfileset refid="libs"/>
			<fileset dir="out/production/gs"/>
		</jar>
	</target>


    <target name="exe" description="(re)creates the grooveJames.exe launcher">
        <fail unless="launch4j.isAvailable"
            message="Cannot create exe because Launch4j not found. Use -Dlaunch4j.dir=[dir] to set the Launch4j installation directory."/>
		<taskdef
			name="launch4j"
			classname="net.sf.launch4j.ant.Launch4jTask"
			classpath="${launch4j.dir}/launch4j.jar"
		/>
		<launch4j configFile="launch4j.xml"/>
    </target>


    <target name="dist-bin" depends="jar" description="create the binary distribution">
        <copy file="grooveJames.exe" todir="out"/>
        <zip destfile="out/grooveJames-${build.number}-bin.zip">
            <zipfileset dir="out" includes="grooveJames.jar, grooveJames.exe"/>
        </zip>
    </target>


	<target name="dist-src" depends="readBuildNumber" description="create source distribution zip file">
		<mkdir dir="out"/>
		<zip destfile="out/grooveJames-${build.number}-src.zip">
			<zipfileset dir="." prefix="grooveJames">
				<exclude name="out/**"/>
                <exclude name="gs.iws"/>
				<exclude name="**/*.log"/>
                <exclude name="**/*.log.*"/>
                <exclude name="**/Thumbs.db"/>
			</zipfileset>
		</zip>
	</target>


    <target name="release-bin" depends="dist-bin">
        <CBRelease
            file="out/grooveJames-${build.number}-bin.zip"
            tofile="grooveJames-${build.number}-bin.zip"
            todir="binaries"
            description="GrooveJames ${build.number} binaries"
            descriptionformat="T"
        />
    </target>


    <target name="release-src" depends="dist-src">
        <CBRelease
            file="out/grooveJames-${build.number}-src.zip"
            tofile="grooveJames-${build.number}-src.zip"
            todir="sources"
            description="GrooveJames ${build.number} sources"
            descriptionformat="T"
        />
    </target>


    <target name="release-all" depends="release-bin, release-src" description="release files on CodeBeamer/JavaForge"/>


    <target name="readBuildNumber">
        <property file="src/groovejames/gui/version.properties"/>
        <echo message="build-number: ${build.number}" level="info"/>
    </target>


    <target name="incBuildNumber" description="increase the build number in version.properties">
        <propertyfile file="src/groovejames/gui/version.properties">
            <entry key="build.number" type="int" operation="+" default="0"/>
        </propertyfile>
        <property file="src/groovejames/gui/version.properties"/>
        <echo message="build-number: ${build.number}" level="info"/>
    </target>


	<target name="all" depends="clean, dist-bin, dist-src" description="cleanup and create source and binary distribution"/>


	<target name="clean" description="cleanup">
		<delete dir="out"/>
		<delete dir="." includes="*.log,*.log.*"/>
	</target>

</project>
